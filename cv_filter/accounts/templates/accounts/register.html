{% extends "accounts/base.html" %}
{% block title %}Register{% endblock %}
{% block content %}
<h1>Create account</h1>
<p class="subtitle">Join CV Filter with a few quick details.</p>

<div id="alert-container"></div>

<form id="register-form">
    <div>
        <label for="username">Username</label>
        <input id="username" name="username" placeholder="jane" required />
    </div>
    <div>
        <label for="email">Email</label>
        <input id="email" name="email" type="email" placeholder="you@example.com" />
    </div>
    <div>
        <label for="password">Password</label>
        <input id="password" name="password" type="password" placeholder="Min. 8 characters" required />
    </div>
    <button type="submit">Create account</button>
</form>

<p class="muted">
    Already have an account?
    <a href="{% url 'login' %}">Sign in</a>
</p>

<script>
const form = document.getElementById('register-form');
const alerts = document.getElementById('alert-container');

function showAlert(message, type = 'error') {
    alerts.innerHTML = `<div class="alert alert-${type}">${message}</div>`;
}

form.addEventListener('submit', async (e) => {
    e.preventDefault();
    alerts.innerHTML = '';
    const data = {
        username: form.username.value.trim(),
        email: form.email.value.trim(),
        password: form.password.value
    };
    try {
        const res = await fetch('{% url "api-register" %}', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
        });
        const body = await res.json();
        if (!res.ok) {
            const detail = body.detail || Object.values(body).flat().join(' ') || 'Could not register.';
            showAlert(detail);
            return;
        }
        showAlert('Account created. Token stored in sessionStorage.', 'success');
        sessionStorage.setItem('access', body.access);
        sessionStorage.setItem('refresh', body.refresh);
    } catch (err) {
        showAlert('Unexpected error. Please try again.');
    }
});
</script>
{% endblock %}
